<!doctype html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Konfiguracja</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="config.css" />
  </head>
  <body>
    <!-- Top Navigation -->
    <nav class="topnav">
      <a href="/" class="topnav-brand">üè† BookingApp</a>
      <div class="topnav-links">
        <a href="/">Rezerwacje</a>
        <a href="/calendar">üìÖ Kalendarz</a>
        <a href="/config" class="active">‚öô Konfiguracja</a>
      </div>
      <div class="topnav-right">
        <span class="topnav-role">üëë Admin</span>
        <button class="topnav-logout" onclick="logoutAdmin()">Wyloguj</button>
      </div>
    </nav>

    <div id="app">
      <!-- Loading -->
      <div v-if="loading" class="config-loading">
        <div class="loading-spinner"></div>
        <span>≈Åadowanie konfiguracji‚Ä¶</span>
      </div>

      <!-- Error -->
      <div v-else-if="error" class="config-loading">
        <span style="color: var(--accent-pink)">‚ö† {{ error }}</span>
      </div>

      <!-- Main layout -->
      <div v-else class="config-layout">
        <!-- Sidebar (desktop) -->
        <aside class="config-sidebar">
          <div class="config-sidebar-title">Konfiguracja</div>
          <button
            class="config-nav-item"
            :class="{ active: activeSection === 'properties' }"
            @click="activeSection = 'properties'"
          >
            üèò Nieruchomo≈õci
            <span class="nav-count">{{ properties.length }}</span>
          </button>
          <button
            class="config-nav-item"
            :class="{ active: activeSection === 'groups' }"
            @click="activeSection = 'groups'"
          >
            üìÅ Grupy
            <span class="nav-count">{{ groups.length }}</span>
          </button>
          <button
            class="config-nav-item"
            :class="{ active: activeSection === 'settings' }"
            @click="activeSection = 'settings'"
          >
            ‚öô Ustawienia
          </button>
        </aside>

        <!-- Content -->
        <main class="config-content">
          <!-- ‚îÄ‚îÄ PROPERTIES SECTION ‚îÄ‚îÄ -->
          <div v-if="activeSection === 'properties'">
            <div class="config-section-header">
              <div>
                <h2 class="config-section-title">Nieruchomo≈õci</h2>
                <p class="config-section-desc">ZarzƒÖdzaj obiektami i ich ≈∫r√≥d≈Çami iCal</p>
              </div>
              <button class="btn-add" @click="openDrawerAdd"><span>+</span> Dodaj</button>
            </div>

            <!-- Empty state -->
            <div v-if="properties.length === 0" class="empty-state">
              <div class="empty-state-icon">üèò</div>
              <strong>Brak nieruchomo≈õci</strong>
              <span>Dodaj pierwszƒÖ nieruchomo≈õƒá przyciskiem powy≈ºej</span>
            </div>

            <!-- Cards grid -->
            <div v-else class="prop-cards-grid">
              <div v-for="property in properties" :key="property.id" class="prop-card">
                <!-- Card header -->
                <div class="prop-card-header">
                  <div>
                    <div class="prop-card-title">{{ property.displayName }}</div>
                    <div class="prop-card-key">{{ property.name }}</div>
                  </div>
                  <div class="prop-card-actions">
                    <button
                      class="prop-icon-btn"
                      data-tooltip="Kopiuj link do kalendarza iCal"
                      @click="copyExportUrl(property.exportUrl)"
                    >
                      üîó
                    </button>
                    <button
                      class="prop-icon-btn regen"
                      data-tooltip="Regeneruj token eksportu (stary link przestanie dzia≈Çaƒá)"
                      @click="regenerateToken(property.id)"
                    >
                      üîÑ
                    </button>
                    <button
                      class="prop-icon-btn"
                      data-tooltip="Edytuj nieruchomo≈õƒá"
                      @click="openDrawerEdit(property)"
                    >
                      ‚úèÔ∏è
                    </button>
                    <button
                      class="prop-icon-btn danger"
                      data-tooltip="Usu≈Ñ nieruchomo≈õƒá"
                      @click="deleteProperty(property.id)"
                    >
                      üóë
                    </button>
                  </div>
                </div>

                <!-- Badges -->
                <div class="prop-card-meta">
                  <span v-if="property.groupName" class="prop-badge group">
                    üìÅ {{ property.groupName }}
                  </span>
                  <span v-else class="prop-badge no-group">Brak grupy</span>
                  <span class="prop-badge cost"> üßπ {{ property.cleaningCost || 0 }} z≈Ç </span>
                </div>

                <!-- Sources toggle -->
                <button class="prop-sources-toggle" @click="toggleSources(property.id)">
                  üì° ≈πr√≥d≈Ça iCal
                  <span class="sources-count">{{ property.sourcesCount || 0 }}</span>
                  <span style="margin-left: 6px; font-size: 0.7rem">
                    {{ expandedPropertyId === property.id ? '‚ñ≤' : '‚ñº' }}
                  </span>
                </button>

                <!-- Sources panel -->
                <div v-if="expandedPropertyId === property.id" class="prop-sources-panel">
                  <div
                    v-if="sourcesLoading"
                    style="color: var(--text-muted); font-size: 0.8rem; padding: 4px 0"
                  >
                    ≈Åadowanie‚Ä¶
                  </div>
                  <div v-else>
                    <div v-for="src in propertySources" :key="src.id" class="source-item">
                      <template v-if="editingSourceId === src.id">
                        <input
                          v-model="editSourceForm.icalUrl"
                          class="cfg-input source-input-url"
                          placeholder="iCal URL"
                        />
                        <input
                          v-model="editSourceForm.source"
                          class="cfg-input source-input-platform"
                          placeholder="booking/airbnb"
                        />
                        <button
                          class="prop-icon-btn"
                          @click="saveEditSource(property.id, src.id)"
                          data-tooltip="Zapisz zmiany"
                        >
                          üíæ
                        </button>
                        <button
                          class="prop-icon-btn"
                          @click="cancelEditSource"
                          data-tooltip="Anuluj edycjƒô"
                        >
                          ‚úñ
                        </button>
                      </template>
                      <template v-else>
                        <span class="source-url">{{ src.icalUrl }}</span>
                        <span
                          :class="['source-platform', src.source?.toLowerCase() === 'booking' ? 'booking' : src.source?.toLowerCase() === 'airbnb' ? 'airbnb' : 'other']"
                        >
                          {{ src.source }}
                        </span>
                        <button
                          class="prop-icon-btn"
                          @click="startEditSource(src)"
                          data-tooltip="Edytuj ≈∫r√≥d≈Ço"
                        >
                          ‚úèÔ∏è
                        </button>
                        <button
                          class="prop-icon-btn danger"
                          @click="deleteSource(property.id, src.id)"
                          data-tooltip="Usu≈Ñ ≈∫r√≥d≈Ço iCal"
                        >
                          üóë
                        </button>
                      </template>
                    </div>

                    <!-- Add source row -->
                    <div class="source-add-row">
                      <input
                        v-model="sourceForm.icalUrl"
                        class="cfg-input source-input-url"
                        placeholder="Nowy iCal URL"
                      />
                      <input
                        v-model="sourceForm.source"
                        class="cfg-input source-input-platform"
                        placeholder="booking / airbnb"
                      />
                      <button class="btn-add" @click="addSource(property.id)">+ Dodaj</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ‚îÄ‚îÄ GROUPS SECTION ‚îÄ‚îÄ -->
          <div v-if="activeSection === 'groups'">
            <div class="config-section-header">
              <div>
                <h2 class="config-section-title">Grupy</h2>
                <p class="config-section-desc">Organizuj nieruchomo≈õci w grupy</p>
              </div>
            </div>

            <!-- Add group form -->
            <div class="settings-card" style="margin-bottom: 24px">
              <form
                @submit.prevent="addGroup"
                style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap"
              >
                <div class="cfg-field" style="flex: 1; margin-bottom: 0; min-width: 160px">
                  <label class="cfg-label">Nazwa grupy</label>
                  <input
                    v-model="groupForm.groupName"
                    class="cfg-input"
                    placeholder="np. Krak√≥w"
                    required
                  />
                </div>
                <button class="btn-add" type="submit">+ Dodaj grupƒô</button>
              </form>
            </div>

            <!-- Empty state -->
            <div v-if="groups.length === 0" class="empty-state">
              <div class="empty-state-icon">üìÅ</div>
              <strong>Brak grup</strong>
            </div>

            <!-- Groups list -->
            <div v-else class="groups-list">
              <div v-for="group in groups" :key="group._id" class="group-row">
                <template v-if="editingGroupId === group._id">
                  <input v-model="editGroupForm.name" class="cfg-input" style="flex: 1" />
                  <button
                    class="prop-icon-btn"
                    @click="saveEditGroup(group._id)"
                    data-tooltip="Zapisz zmiany"
                  >
                    üíæ
                  </button>
                  <button
                    class="prop-icon-btn"
                    @click="cancelEditGroup"
                    data-tooltip="Anuluj edycjƒô"
                  >
                    ‚úñ
                  </button>
                </template>
                <template v-else>
                  <div class="group-row-name">{{ group.name }}</div>
                  <span class="group-count-pill">{{ group.propertyCount || 0 }} obiekt√≥w</span>
                  <div class="group-row-actions">
                    <button
                      class="prop-icon-btn"
                      @click="startEditGroup(group)"
                      data-tooltip="Edytuj nazwƒô grupy"
                    >
                      ‚úèÔ∏è
                    </button>
                    <button
                      class="prop-icon-btn danger"
                      @click="deleteGroup(group._id)"
                      data-tooltip="Usu≈Ñ grupƒô"
                    >
                      üóë
                    </button>
                  </div>
                </template>
              </div>
            </div>
          </div>

          <!-- ‚îÄ‚îÄ SETTINGS SECTION ‚îÄ‚îÄ -->
          <div v-if="activeSection === 'settings'">
            <div class="config-section-header">
              <div>
                <h2 class="config-section-title">Ustawienia aplikacji</h2>
                <p class="config-section-desc">Globalna konfiguracja widoku</p>
              </div>
            </div>

            <div class="settings-card">
              <div class="settings-field">
                <label class="settings-label">Domy≈õlna grupa (widok g≈Ç√≥wny)</label>
                <p class="settings-hint">
                  Wybrana grupa jest wstƒôpnie zaznaczona na stronie rezerwacji
                </p>
                <select
                  v-model="settings.defaultGroupId"
                  class="cfg-select"
                  style="margin-top: 4px"
                >
                  <option value="">Wszystkie grupy</option>
                  <option v-for="g in groups" :key="g._id" :value="g._id">{{ g.name }}</option>
                </select>
              </div>
              <div class="settings-save-row">
                <button
                  class="cfg-btn-primary"
                  @click="saveSettings"
                  :disabled="settingsSaving"
                  style="max-width: 160px"
                >
                  {{ settingsSaving ? 'Zapisujƒô‚Ä¶' : 'üíæ Zapisz' }}
                </button>
                <span v-if="settingsMsg" class="settings-msg">{{ settingsMsg }}</span>
              </div>
            </div>
          </div>
        </main>
      </div>

      <!-- ‚îÄ‚îÄ DRAWER (add/edit property) ‚îÄ‚îÄ -->
      <div
        v-if="drawerOpen"
        class="cfg-drawer-overlay"
        :class="{ open: drawerOpen }"
        @click="closeDrawer"
      ></div>
      <div class="cfg-drawer-panel" :class="{ open: drawerOpen }">
        <div class="cfg-drawer-header">
          <span class="cfg-drawer-title">
            {{ drawerMode === 'add' ? 'Nowa nieruchomo≈õƒá' : 'Edytuj nieruchomo≈õƒá' }}
          </span>
          <button class="cfg-drawer-close" @click="closeDrawer">‚úï</button>
        </div>

        <div class="cfg-drawer-tabs" v-if="drawerMode === 'edit'">
          <button
            class="cfg-drawer-tab"
            :class="{ active: drawerTab === 'data' }"
            @click="drawerTab = 'data'"
          >
            Dane
          </button>
          <button
            class="cfg-drawer-tab"
            :class="{ active: drawerTab === 'sources' }"
            @click="switchDrawerToSources"
          >
            ≈πr√≥d≈Ça iCal
          </button>
        </div>

        <div class="cfg-drawer-body">
          <!-- Data tab -->
          <div v-if="drawerTab === 'data'">
            <div v-if="drawerError" class="cfg-error-msg">{{ drawerError }}</div>
            <div class="cfg-field">
              <label class="cfg-label">Klucz (unikalny identyfikator)</label>
              <input
                v-model="drawerForm.name"
                class="cfg-input"
                placeholder="np. apt-krakow-1"
                :disabled="drawerMode === 'edit'"
              />
            </div>
            <div class="cfg-field">
              <label class="cfg-label">Nazwa wy≈õwietlana</label>
              <input
                v-model="drawerForm.displayName"
                class="cfg-input"
                placeholder="np. Apartament Krak√≥w 1"
              />
            </div>
            <div class="cfg-field">
              <label class="cfg-label">Koszt sprzƒÖtania (z≈Ç)</label>
              <input
                v-model.number="drawerForm.cleaningCost"
                type="number"
                class="cfg-input"
                placeholder="0"
                min="0"
                step="0.01"
              />
            </div>
            <div class="cfg-field">
              <label class="cfg-label">Grupa</label>
              <select v-model="drawerForm.groupId" class="cfg-select">
                <option value="">Brak grupy</option>
                <option v-for="g in groups" :key="g._id" :value="g._id">{{ g.name }}</option>
              </select>
            </div>
          </div>

          <!-- Sources tab -->
          <div v-if="drawerTab === 'sources'">
            <div
              v-if="sourcesLoading"
              style="color: var(--text-muted); font-size: 0.83rem; padding: 8px 0"
            >
              ≈Åadowanie‚Ä¶
            </div>
            <div v-else>
              <div
                v-for="src in propertySources"
                :key="src.id"
                class="source-item"
                style="flex-wrap: wrap; gap: 6px"
              >
                <template v-if="editingSourceId === src.id">
                  <input
                    v-model="editSourceForm.icalUrl"
                    class="cfg-input source-input-url"
                    placeholder="iCal URL"
                  />
                  <input
                    v-model="editSourceForm.source"
                    class="cfg-input source-input-platform"
                    placeholder="booking/airbnb"
                    style="margin-top: 6px"
                  />
                  <div style="display: flex; gap: 6px; margin-top: 6px">
                    <button
                      class="cfg-btn-primary"
                      style="max-width: 80px; padding: 7px 0"
                      @click="saveEditSource(drawerPropertyId, src.id)"
                    >
                      üíæ
                    </button>
                    <button class="cfg-btn-secondary" @click="cancelEditSource">Anuluj</button>
                  </div>
                </template>
                <template v-else>
                  <span class="source-url">{{ src.icalUrl }}</span>
                  <div style="display: flex; gap: 6px; align-items: center; width: 100%">
                    <span
                      :class="['source-platform', src.source?.toLowerCase() === 'booking' ? 'booking' : src.source?.toLowerCase() === 'airbnb' ? 'airbnb' : 'other']"
                      >{{ src.source }}</span
                    >
                    <button
                      class="prop-icon-btn"
                      @click="startEditSource(src)"
                      title="Edytuj"
                      style="margin-left: auto"
                    >
                      ‚úèÔ∏è
                    </button>
                    <button
                      class="prop-icon-btn danger"
                      @click="deleteSource(drawerPropertyId, src.id)"
                      title="Usu≈Ñ"
                    >
                      üóë
                    </button>
                  </div>
                </template>
              </div>

              <div v-if="propertySources.length === 0" class="empty-state" style="padding: 24px 0">
                <div class="empty-state-icon">üì°</div>
                <span>Brak ≈∫r√≥de≈Ç iCal</span>
              </div>

              <div class="source-add-row">
                <input
                  v-model="sourceForm.icalUrl"
                  class="cfg-input source-input-url"
                  placeholder="Nowy iCal URL"
                />
                <input
                  v-model="sourceForm.source"
                  class="cfg-input source-input-platform"
                  placeholder="booking / airbnb"
                />
                <button class="btn-add" @click="addSource(drawerPropertyId)">+ Dodaj</button>
              </div>
            </div>
          </div>
        </div>

        <div class="cfg-drawer-footer">
          <button class="cfg-btn-primary" @click="submitDrawer" :disabled="drawerSaving">
            {{ drawerSaving ? 'Zapisujƒô‚Ä¶' : (drawerMode === 'add' ? 'Dodaj nieruchomo≈õƒá' : 'Zapisz
            zmiany') }}
          </button>
          <button class="cfg-btn-secondary" @click="closeDrawer">Anuluj</button>
        </div>
      </div>

      <!-- Modal -->
      <div v-if="modal.open" class="cfg-modal-overlay" @click.self="dismissModal">
        <div class="cfg-modal" role="dialog">
          <div class="cfg-modal-header">
            <span class="cfg-modal-icon">{{ modal.type === 'confirm' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è' }}</span>
            <h3 class="cfg-modal-title">{{ modal.title }}</h3>
          </div>
          <p class="cfg-modal-body">{{ modal.message }}</p>
          <div class="cfg-modal-footer">
            <button v-if="modal.type === 'confirm'" class="cfg-btn-danger" @click="confirmModal">
              Potwierd≈∫
            </button>
            <button class="cfg-btn-secondary" @click="dismissModal">
              {{ modal.type === 'confirm' ? 'Anuluj' : 'OK' }}
            </button>
          </div>
        </div>
      </div>

      <!-- Toast -->
      <div :class="['config-toast', toast ? 'active' : '']">{{ toast }}</div>

      <!-- Mobile bottom navigation -->
      <nav class="config-bottom-nav">
        <button
          class="config-bottom-nav-item"
          :class="{ active: activeSection === 'properties' }"
          @click="activeSection = 'properties'"
        >
          <span class="bottom-nav-icon">üèò</span>
          <span class="bottom-nav-label">Obiekty</span>
        </button>
        <button
          class="config-bottom-nav-item"
          :class="{ active: activeSection === 'groups' }"
          @click="activeSection = 'groups'"
        >
          <span class="bottom-nav-icon">üìÅ</span>
          <span class="bottom-nav-label">Grupy</span>
        </button>
        <button
          class="config-bottom-nav-item"
          :class="{ active: activeSection === 'settings' }"
          @click="activeSection = 'settings'"
        >
          <span class="bottom-nav-icon">‚öô</span>
          <span class="bottom-nav-label">Ustawienia</span>
        </button>
      </nav>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script>
      (async () => {
        try {
          const res = await fetch('/auth/me');
          const data = await res.json();
          if (!data.success || data.role !== 'admin')
            window.location.href = '/login?redirect=/config';
        } catch {
          window.location.href = '/login?redirect=/config';
        }
      })();
      async function logoutAdmin() {
        await fetch('/auth/logout', { method: 'POST' });
        window.location.href = '/login';
      }
    </script>
    <script src="config-app.js"></script>
    <script>
      createApp(ConfigApp).mount('#app');
    </script>
  </body>
</html>
