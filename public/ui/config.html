<!-- public/config.html -->
<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rezerwacje (iCal)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <a href="/index.html" class="config-button">‚Üê Powr√≥t do g≈Ç√≥wnej strony</a>
    <!-- Main Content -->
    <main>
      <h2>Property iCal Config</h2>
      <div class="grid" style="margin-bottom: 16px">
        <div class="card">
          <h3>Dodaj nieruchomo≈õƒá</h3>
          <form id="addForm">
            <input name="name" class="input" placeholder="Property Name" required />
            <input name="icalUrl" class="input" placeholder="iCal URL" required />
            <input
              name="source"
              class="input"
              placeholder="Source (e.g., booking, airbnb, expedia)"
              required
            />
            <input
              name="cleaningCost"
              type="number"
              class="input"
              placeholder="Cleaning Cost"
              min="0"
              step="0.01"
            />
            <div class="apartment-dropdown-container">
              <select name="groupId" class="apartment-select-trigger">
                <option value="">Brak grupy</option>
                <!-- Opcje grup bƒôdƒÖ dodane przez JS -->
              </select>
            </div>
            <button class="action-button primary" type="submit">Add</button>
          </form>
        </div>
        <div class="card">
          <h3>Dodaj grupƒô</h3>
          <form id="addGroupForm">
            <input name="groupName" class="input" placeholder="Group Name" required />
            <button class="action-button primary" type="submit">Add Group</button>
          </form>
        </div>
      </div>
      <div class="card" style="margin-bottom: 16px">
        <h3>Nieruchomo≈õci</h3>
        <table id="propTable">
          <thead>
            <tr>
              <th>Nazwa</th>
              <th>iCal URL</th>
              <th>≈πr√≥d≈Ço</th>
              <th>Cleaning Cost</th>
              <th>Grupa</th>
              <th style="width: 120px">Akcje</th>
            </tr>
          </thead>
          <tbody>
            <!-- Rows generated by JS -->
          </tbody>
        </table>
      </div>

      <div class="card">
        <h3>Grupy</h3>
        <table id="groupTable">
          <thead>
            <tr>
              <th>Nazwa</th>
              <th>Liczba nieruchomo≈õci</th>
              <th style="width: 120px">Akcje</th>
            </tr>
          </thead>
          <tbody>
            <!-- Rows generated by JS -->
          </tbody>
        </table>
      </div>
    </main>
    <script>
      let editingId = null;
      let editingGroupId = null;
      let groups = [];

      async function loadGroups() {
        const res = await fetch('/ical/groups');
        const data = await res.json();
        groups = data.groups;
        updateGroupSelects();
        updateGroupTable();
      }

      function updateGroupSelects() {
        const selects = document.querySelectorAll('select[name="groupId"]');
        selects.forEach((select) => {
          select.innerHTML =
            '<option value="">Brak grupy</option>' +
            groups.map((g) => `<option value="${g._id}">${g.name}</option>`).join('');
        });
      }

      function updateGroupTable() {
        const tbody = document.querySelector('#groupTable tbody');
        tbody.innerHTML = groups
          .map((g) => {
            if (editingGroupId === g._id) {
              return `<tr>
            <td><input class="input" id="editGroupName" value="${g.name}"></td>
            <td>${g.propertyCount || 0}</td>
            <td>
              <button class="action-button primary" onclick="saveGroupEdit('${g._id}')">üíæ</button>
              <button class="action-button" onclick="cancelGroupEdit()">‚úñÔ∏è</button>
            </td>
          </tr>`;
            }
            return `<tr>
          <td>${g.name}</td>
          <td>${g.propertyCount || 0}</td>
          <td>
            <button class="action-button" onclick="startGroupEdit('${g._id}')">‚úèÔ∏è</button>
            <button class="action-button" onclick="delGroup('${
              g._id
            }')" style="color:#ff7ad9">üóëÔ∏è</button>
          </td>
        </tr>`;
          })
          .join('');
      }

      async function load() {
        const res = await fetch('/ical/properties');
        const data = await res.json();
        const tbody = document.querySelector('#propTable tbody');
        tbody.innerHTML = data.properties
          .map((p) => {
            if (editingId === p._id) {
              return `<tr>
            <td><input class="input" id="editName" value="${p.name}"></td>
            <td><input class="input" id="editUrl" value="${p.icalUrl}"></td>
            <td><input class="input" id="editSource" value="${p.source}"></td>
            <td><input type="number" class="input" id="editCleaningCost" value="${
              p.cleaningCost || 0
            }" min="0" step="0.01"></td>
            <td><select class="filter-select" id="editGroupId">
              <option value="">Brak grupy</option>
              ${groups
                .map(
                  (g) =>
                    `<option value="${g._id}" ${
                      p.groupId && p.groupId._id === g._id ? 'selected' : ''
                    }>${g.name}</option>`,
                )
                .join('')}
            </select></td>
            <td>
              <button class="action-button primary" onclick="saveEdit('${p._id}')">üíæ</button>
              <button class="action-button" onclick="cancelEdit()">‚úñÔ∏è</button>
            </td>
          </tr>`;
            }
            return `<tr>
          <td>${p.name}</td>
          <td class="muted" style="font-size:12px;word-break:break-all">${p.icalUrl}</td>
          <td>${p.source}</td>
          <td>${p.cleaningCost || 0}</td>
          <td>${p.groupId ? p.groupId.name : 'Brak'}</td>
          <td>
            <button class="action-button" onclick="startEdit('${p._id}')">‚úèÔ∏è</button>
            <button class="action-button" onclick="del('${
              p._id
            }')" style="color:#ff7ad9">üóëÔ∏è</button>
          </td>
        </tr>`;
          })
          .join('');
      }

      document.getElementById('addForm').onsubmit = async (e) => {
        e.preventDefault();
        const form = e.target;
        await fetch('/ical/properties', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: form.name.value,
            icalUrl: form.icalUrl.value,
            source: form.source.value,
            cleaningCost: parseFloat(form.cleaningCost.value) || 0,
            groupId: form.groupId.value || undefined,
          }),
        });
        form.reset();
        await loadGroups(); // Refresh group counts
        load();
      };

      document.getElementById('addGroupForm').onsubmit = async (e) => {
        e.preventDefault();
        const form = e.target;
        await fetch('/ical/groups', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: form.groupName.value,
          }),
        });
        form.reset();
        await loadGroups();
        load(); // Refresh properties table to update group dropdown
      };

      window.del = async function (id) {
        if (!confirm('Na pewno usunƒÖƒá?')) return;
        await fetch('/ical/properties/' + id, { method: 'DELETE' });
        await loadGroups(); // Refresh group counts
        load();
      };

      window.startEdit = function (id) {
        editingId = id;
        load();
      };

      window.cancelEdit = function () {
        editingId = null;
        load();
      };

      window.saveEdit = async function (id) {
        const name = document.getElementById('editName').value;
        const icalUrl = document.getElementById('editUrl').value;
        const source = document.getElementById('editSource').value;
        const cleaningCost = parseFloat(document.getElementById('editCleaningCost').value) || 0;
        const groupId = document.getElementById('editGroupId').value || undefined;
        await fetch('/ical/properties/' + id, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, icalUrl, source, cleaningCost, groupId }),
        });
        editingId = null;
        await loadGroups(); // Refresh group counts
        load();
      };

      window.delGroup = async function (id) {
        if (!confirm('Na pewno usunƒÖƒá grupƒô?')) return;
        await fetch('/ical/groups/' + id, { method: 'DELETE' });
        await loadGroups();
        load(); // Refresh properties table
      };

      window.startGroupEdit = function (id) {
        editingGroupId = id;
        updateGroupTable();
      };

      window.cancelGroupEdit = function () {
        editingGroupId = null;
        updateGroupTable();
      };

      window.saveGroupEdit = async function (id) {
        const name = document.getElementById('editGroupName').value;
        await fetch('/ical/groups/' + id, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name }),
        });
        editingGroupId = null;
        await loadGroups();
        load(); // Refresh properties table
      };

      loadGroups();
      load();
    </script>
  </body>
</html>
