<!doctype html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kalendarz blokad</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      <body v-cloak>
    />
    <link rel="stylesheet" href="styles.css" />

    <!-- FullCalendar via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 0;
        background: #0f1117;
        color: #e2e8f0;
        font-family: 'Inter', sans-serif;
        min-height: 100vh;
      }
      .page-header {
        display: none; /* replaced by .topnav */
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 16px;
      }
      .prop-tabs-header {
        font-size: 0.72rem;
        font-weight: 600;
        letter-spacing: 0.07em;
        color: #4a5568;
        text-transform: uppercase;
        margin-bottom: 8px;
      }
      .prop-tabs {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 20px;
        align-items: center;
      }
      .prop-tab {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 3px;
        background: #1e2533;
        border: 1px solid #2d3748;
        border-radius: 10px;
        padding: 10px 16px;
        cursor: pointer;
        transition:
          border-color 0.15s,
          background 0.15s,
          box-shadow 0.15s;
        font-family: inherit;
        text-align: left;
        min-width: 130px;
      }
      .prop-tab:hover {
        background: #252e42;
        border-color: #4a5568;
      }
      .prop-tab.active {
        background: rgba(66, 153, 225, 0.08);
        border-color: #4299e1;
        box-shadow: 0 0 0 1px rgba(66, 153, 225, 0.18);
      }
      .prop-tab-name {
        font-size: 0.9rem;
        font-weight: 600;
        color: #e2e8f0;
      }
      .prop-tab.active .prop-tab-name {
        color: #63b3ed;
      }
      .prop-tab-meta {
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .prop-tab-group {
        font-size: 0.72rem;
        color: #718096;
      }
      .prop-tab-sources {
        font-size: 0.72rem;
        color: #4a5568;
      }
      #calendar-container {
        background: #1a1f2e;
        border: 1px solid #2d3748;
        border-radius: 10px;
        padding: 16px;
      }

      /* FullCalendar dark theme overrides */
      .fc {
        color: #e2e8f0;
      }
      .fc .fc-toolbar-title {
        font-size: 1.1rem;
        color: #e2e8f0;
      }
      .fc .fc-button {
        background: #2d3748;
        border-color: #4a5568;
        color: #e2e8f0;
        font-size: 0.82rem;
      }
      .fc .fc-button:hover {
        background: #3d4a5f;
      }
      .fc .fc-button-primary:not(:disabled).fc-button-active,
      .fc .fc-button-primary:not(:disabled):active {
        background: #4299e1;
        border-color: #4299e1;
      }
      .fc .fc-col-header-cell {
        background: #1a1f2e;
      }
      .fc .fc-col-header-cell-cushion {
        color: #94a3b8;
        font-size: 0.8rem;
        padding: 6px;
      }
      .fc .fc-daygrid-day {
        background: #0f1117;
      }
      .fc .fc-daygrid-day:hover {
        background: #1a1f2e;
      }
      .fc .fc-daygrid-day-number {
        color: #94a3b8;
        font-size: 0.82rem;
        padding: 4px 6px;
      }
      .fc .fc-day-today {
        background: rgba(66, 153, 225, 0.08) !important;
      }
      .fc .fc-day-today .fc-daygrid-day-number {
        color: #4299e1;
        font-weight: 600;
      }
      .fc .fc-scrollgrid {
        border-color: #2d3748;
      }
      .fc .fc-scrollgrid td,
      .fc .fc-scrollgrid th {
        border-color: #2d3748;
      }
      .fc .fc-daygrid-event {
        border-radius: 4px;
        font-size: 0.75rem;
        padding: 1px 4px;
        cursor: pointer;
        border: none;
      }
      .fc .fc-highlight {
        background: rgba(66, 153, 225, 0.2);
      }
      .fc .fc-daygrid-more-link {
        color: #4299e1;
        font-size: 0.75rem;
      }

      /* Event colors */
      .event-booking {
        background: #2b6cb0 !important;
        border-left: 3px solid #4299e1 !important;
      }
      .event-block {
        background: #742a2a !important;
        border-left: 3px solid #fc8181 !important;
      }
      .event-block-conflict {
        background: #744210 !important;
        border-left: 3px solid #f6ad55 !important;
      }

      /* Feed section */
      .feed-section {
        margin-top: 24px;
        background: #1a1f2e;
        border: 1px solid #2d3748;
        border-radius: 10px;
        padding: 16px 20px;
      }
      .feed-section h3 {
        margin: 0 0 12px;
        font-size: 1rem;
        color: #e2e8f0;
      }
      .feed-url-row {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }
      .feed-url {
        flex: 1;
        min-width: 200px;
        background: #0f1117;
        border: 1px solid #2d3748;
        border-radius: 6px;
        padding: 6px 10px;
        color: #94a3b8;
        font-size: 0.82rem;
        font-family: monospace;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .btn {
        font-family: inherit;
        border-radius: 6px;
        padding: 6px 14px;
        cursor: pointer;
        font-size: 0.85rem;
        border: 1px solid transparent;
        transition: opacity 0.15s;
      }
      .btn:hover {
        opacity: 0.85;
      }
      .btn-primary {
        background: #2b6cb0;
        color: #e2e8f0;
        border-color: #4299e1;
      }
      .btn-danger {
        background: rgba(229, 62, 62, 0.15);
        color: #fc8181;
        border-color: rgba(229, 62, 62, 0.4);
      }
      .btn-warning {
        background: rgba(237, 137, 54, 0.2);
        color: #f6ad55;
        border-color: rgba(237, 137, 54, 0.4);
      }
      .feed-hint {
        margin-top: 8px;
        font-size: 0.78rem;
        color: #718096;
      }

      /* Modal */
      .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      .modal-overlay.active {
        display: flex;
      }
      .modal {
        background: #1e2533;
        border: 1px solid #2d3748;
        border-radius: 12px;
        padding: 24px;
        width: 100%;
        max-width: 420px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      }
      .modal h3 {
        margin: 0 0 16px;
        font-size: 1rem;
        color: #e2e8f0;
      }
      .modal label {
        display: block;
        font-size: 0.82rem;
        color: #94a3b8;
        margin-bottom: 4px;
      }
      .modal input[type='date'],
      .modal input[type='text'],
      .modal textarea {
        width: 100%;
        background: #0f1117;
        border: 1px solid #2d3748;
        border-radius: 6px;
        padding: 8px 10px;
        color: #e2e8f0;
        font-size: 0.9rem;
        font-family: inherit;
        margin-bottom: 12px;
      }
      .modal textarea {
        resize: vertical;
        min-height: 60px;
      }
      .modal-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 4px;
      }
      .modal-actions .btn-cancel {
        background: transparent;
        color: #718096;
        border-color: #4a5568;
      }
      .conflict-warning {
        background: rgba(237, 137, 54, 0.1);
        border: 1px solid rgba(237, 137, 54, 0.4);
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 0.82rem;
        color: #f6ad55;
        margin-bottom: 12px;
      }
      .toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: #1a1f2e;
        border: 1px solid #2d3748;
        border-radius: 8px;
        padding: 12px 18px;
        font-size: 0.85rem;
        color: #e2e8f0;
        z-index: 2000;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        display: none;
        max-width: 320px;
      }
      .toast.active {
        display: block;
      }
      .toast.success {
        border-left: 3px solid #68d391;
      }
      .toast.error {
        border-left: 3px solid #fc8181;
      }
      .spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid #4a5568;
        border-top-color: #4299e1;
        border-radius: 50%;
        animation: spin 0.7s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <nav class="topnav">
      <a href="/" class="topnav-brand">üè† BookingApp</a>
      <div class="topnav-links">
        <a href="/">Rezerwacje</a>
        <a href="/calendar" class="active">üìÖ Kalendarz</a>
        <a href="/config" id="nav-config-link" style="display: none">‚öô Konfiguracja</a>
      </div>
      <div class="topnav-right">
        <span id="nav-role-badge" class="topnav-role" style="display: none"></span>
        <button id="btn-logout" class="topnav-logout">Wyloguj</button>
      </div>
    </nav>

    <div class="container">
      <!-- Property selector -->
      <div class="prop-tabs-header">Nieruchomo≈õƒá</div>
      <div class="prop-tabs" id="prop-tabs">
        <span id="loading-indicator" style="display: none"><span class="spinner"></span></span>
      </div>

      <!-- Calendar -->
      <div id="calendar-container">
        <div id="calendar"></div>
      </div>

      <!-- iCal Feed section -->
      <div class="feed-section" id="feed-section" style="display: none">
        <h3>üîó Feed iCal (eksport do Booking.com / Airbnb)</h3>
        <div class="feed-url-row">
          <div class="feed-url" id="feed-url-display">‚Äî</div>
          <button class="btn btn-primary" onclick="copyFeedUrl()">Kopiuj link</button>
          <button class="btn btn-warning" onclick="regenerateToken()">Regeneruj link</button>
        </div>
        <div class="feed-hint">
          Wklej ten adres w Booking.com ‚Üí Zewnƒôtrzny kalendarz ‚Üí Importuj<br />
          lub w Airbnb ‚Üí Kalendarz ‚Üí Eksportuj i Importuj ‚Üí Import kalendarza
        </div>
      </div>
    </div>

    <!-- Modal tworzenia blokady -->
    <div class="modal-overlay" id="modal-create">
      <div class="modal">
        <h3>üîí Nowa blokada</h3>
        <label>Data rozpoczƒôcia</label>
        <input type="date" id="block-start" />
        <label>Data zako≈Ñczenia</label>
        <input type="date" id="block-end" />
        <label>Pow√≥d (opcjonalnie)</label>
        <input type="text" id="block-reason" placeholder="np. Remont, prywatne..." />
        <div class="modal-actions">
          <button class="btn btn-cancel btn" onclick="closeModals()">Anuluj</button>
          <button class="btn btn-danger" onclick="createBlock()">Zablokuj</button>
        </div>
      </div>
    </div>

    <!-- Modal edycji blokady -->
    <div class="modal-overlay" id="modal-edit">
      <div class="modal">
        <h3>‚úèÔ∏è Edytuj blokadƒô</h3>
        <div class="conflict-warning" id="edit-conflict-warning" style="display: none">
          ‚ö†Ô∏è Ta blokada nak≈Çada siƒô z rezerwacjƒÖ z zewnƒôtrznej platformy! Usu≈Ñ blokadƒô lub
          skontaktuj siƒô z platformƒÖ.
        </div>
        <label>Data rozpoczƒôcia</label>
        <input type="date" id="edit-block-start" />
        <label>Data zako≈Ñczenia</label>
        <input type="date" id="edit-block-end" />
        <label>Pow√≥d (opcjonalnie)</label>
        <input type="text" id="edit-block-reason" placeholder="np. Remont, prywatne..." />
        <div class="modal-actions">
          <button class="btn btn-cancel btn" onclick="closeModals()">Anuluj</button>
          <button class="btn btn-danger" id="btn-delete-block" onclick="deleteBlock()">
            Usu≈Ñ blokadƒô
          </button>
          <button class="btn btn-primary" onclick="saveBlock()">Zapisz</button>
        </div>
      </div>
    </div>

    <!-- Modal podglƒÖdu rezerwacji -->
    <div class="modal-overlay" id="modal-view">
      <div class="modal">
        <h3>üìã Rezerwacja</h3>
        <div id="view-details" style="font-size: 0.9rem; line-height: 1.7; color: #94a3b8"></div>
        <div class="modal-actions">
          <button class="btn btn-cancel btn" onclick="closeModals()">Zamknij</button>
        </div>
      </div>
    </div>

    <!-- Conflict alert modal -->
    <div class="modal-overlay" id="modal-conflicts">
      <div class="modal">
        <h3 id="conflicts-modal-title">‚ö†Ô∏è Wykryto konflikty blokad</h3>
        <div id="conflicts-list" style="font-size: 0.85rem; line-height: 1.8"></div>
        <div class="modal-actions">
          <button
            class="btn btn-cancel btn"
            onclick="document.getElementById('modal-conflicts').classList.remove('active')"
          >
            Rozumiem
          </button>
        </div>
      </div>
    </div>

    <!-- Confirm modal -->
    <div class="modal-overlay" id="modal-confirm">
      <div class="modal" style="max-width: 380px">
        <h3 id="confirm-icon-title">‚ö†Ô∏è Potwierdzenie</h3>
        <p
          id="confirm-body"
          style="font-size: 0.875rem; color: #94a3b8; line-height: 1.6; margin: 0 0 18px"
        ></p>
        <div class="modal-actions">
          <button class="btn btn-cancel btn" id="confirm-cancel-btn">Anuluj</button>
          <button class="btn btn-danger" id="confirm-ok-btn">Potwierd≈∫</button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
      // Remove v-cloak once DOM is ready so page becomes visible
      document.addEventListener('DOMContentLoaded', () => {
        try {
          document.body.removeAttribute('v-cloak');
        } catch (e) {}
      });
      let calendar = null;
      let selectedPropertyId = null;
      let selectedPropertyName = null;
      let properties = [];
      let editingBlockId = null;

      // ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let isAdmin = false;
      async function checkAuth() {
        const res = await fetch('/auth/me');
        const data = await res.json();
        isAdmin = data.role === 'admin';
        const badge = document.getElementById('nav-role-badge');
        const cfgLink = document.getElementById('nav-config-link');
        if (isAdmin) {
          badge.textContent = 'üëë Admin';
          badge.style.display = '';
          if (cfgLink) cfgLink.style.display = '';
        } else {
          // view-only mode for public users ‚Äî hide admin UI
          if (badge) badge.style.display = 'none';
          if (cfgLink) cfgLink.style.display = 'none';
        }
      }

      document.getElementById('btn-logout').addEventListener('click', async () => {
        await fetch('/auth/logout', { method: 'POST' });
        window.location.href = '/login';
      });

      // ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function showToast(msg, type = 'success') {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.className = `toast active ${type}`;
        setTimeout(() => t.classList.remove('active'), 3500);
      }

      // ‚îÄ‚îÄ iCal conflict blocked modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function showICalConflictModal(conflicts, mode) {
        const title =
          mode === 'edit' ? 'üö´ Nie mo≈ºna zapisaƒá blokady' : 'üö´ Nie mo≈ºna dodaƒá blokady';
        document.getElementById('conflicts-modal-title').textContent = title;
        const lines = conflicts
          .map((c) => {
            const src = (c.source || '').toLowerCase();
            let platform = 'Zewnƒôtrzna platforma';
            if (src === 'booking' || src.includes('booking.com')) platform = 'Booking.com';
            else if (src === 'airbnb' || src.includes('airbnb.')) platform = 'Airbnb';
            const s = new Date(c.start).toLocaleDateString('pl-PL', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
            });
            const e = new Date(c.end).toLocaleDateString('pl-PL', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
            });
            return `<div style="padding:4px 0;">‚úà <strong>${platform}</strong>: ${s} ‚Äì ${e}</div>`;
          })
          .join('');
        document.getElementById('conflicts-list').innerHTML =
          `<div style="margin-bottom:10px; color:#f87171;">Ten termin jest ju≈º zajƒôty przez rezerwacjƒô z zewnƒôtrznej platformy:</div>${lines}`;
        document.getElementById('modal-conflicts').classList.add('active');
      }

      // ‚îÄ‚îÄ Source label helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function srcLabel(raw) {
        if (!raw || raw === 'manual') return 'Rezerwacja';
        if (raw === 'booking' || raw.includes('booking.com')) return 'Booking.com';
        if (raw === 'airbnb' || raw.includes('airbnb.')) return 'Airbnb';
        if (raw.includes('expedia.com')) return 'Expedia';
        if (raw.includes('vrbo.com')) return 'VRBO';
        if (raw.includes('tripadvisor.com')) return 'TripAdvisor';
        try {
          return new URL(raw).hostname.replace('www.', '').split('.')[0];
        } catch {}
        return raw;
      }

      // ‚îÄ‚îÄ Modal helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function closeModals() {
        document
          .querySelectorAll('.modal-overlay:not(#modal-confirm)')
          .forEach((m) => m.classList.remove('active'));
        editingBlockId = null;
      }

      // ‚îÄ‚îÄ Confirm dialog (replaces browser confirm()) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function showConfirm(title, message) {
        return new Promise((resolve) => {
          document.getElementById('confirm-icon-title').textContent = title;
          document.getElementById('confirm-body').textContent = message;
          const overlay = document.getElementById('modal-confirm');
          overlay.classList.add('active');
          const okBtn = document.getElementById('confirm-ok-btn');
          const cancelBtn = document.getElementById('confirm-cancel-btn');
          function cleanup() {
            overlay.classList.remove('active');
            okBtn.removeEventListener('click', onOk);
            cancelBtn.removeEventListener('click', onCancel);
          }
          function onOk() {
            cleanup();
            resolve(true);
          }
          function onCancel() {
            cleanup();
            resolve(false);
          }
          okBtn.addEventListener('click', onOk);
          cancelBtn.addEventListener('click', onCancel);
        });
      }

      document.querySelectorAll('.modal-overlay').forEach((overlay) => {
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) closeModals();
        });
      });

      // ‚îÄ‚îÄ Load properties ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function loadProperties() {
        const res = await fetch('/ical/properties');
        const data = await res.json();
        if (!data.success) return;
        properties = data.properties || [];
        const container = document.getElementById('prop-tabs');
        const loader = document.getElementById('loading-indicator');
        container.innerHTML = '';
        if (loader) container.appendChild(loader);
        properties.forEach((p) => {
          const btn = document.createElement('button');
          btn.className = 'prop-tab';
          btn.dataset.id = p.id;
          const groupHtml = p.groupName
            ? `<span class="prop-tab-group">üìÅ ${p.groupName}</span>`
            : '';
          const srcHtml = p.sourcesCount
            ? `<span class="prop-tab-sources">${p.sourcesCount} ≈∫r√≥d≈Ç${p.sourcesCount === 1 ? 'o' : p.sourcesCount < 5 ? 'a' : ''}</span>`
            : '';
          const metaHtml =
            groupHtml || srcHtml ? `<span class="prop-tab-meta">${groupHtml}${srcHtml}</span>` : '';
          btn.innerHTML = `<span class="prop-tab-name">${p.displayName}</span>${metaHtml}`;
          btn.addEventListener('click', () => selectProperty(p.id));
          container.appendChild(btn);
        });
        // Auto-select first property by default
        if (properties.length >= 1) selectProperty(properties[0].id);
      }

      // ‚îÄ‚îÄ Calendar init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function initCalendar(propertyId) {
        const calendarEl = document.getElementById('calendar');
        const savedDate = calendar
          ? calendar.getDate()
          : localStorage.getItem('calendar_date')
            ? new Date(localStorage.getItem('calendar_date'))
            : null;
        if (calendar) {
          calendar.destroy();
        }

        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          initialDate: savedDate || undefined,
          locale: 'pl',
          firstDay: 1,
          height: 'auto',
          selectable: Boolean(isAdmin),
          selectMirror: true,
          unselectAuto: true,
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth',
          },
          buttonText: { today: 'Dzi≈õ' },

          // Background sync on navigation (prev/next/today)
          datesSet: function (info) {
            const from = info.startStr.slice(0, 10);
            const to = info.endStr.slice(0, 10);
            localStorage.setItem(
              'calendar_date',
              info.view.currentStart.toISOString().slice(0, 10),
            );
            fetch('/ical/sync', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ from, to }),
            })
              .then((r) => r.ok && calendar && calendar.refetchEvents())
              .catch(() => {});
          },

          // Load events
          events: async function (info, successCallback, failureCallback) {
            try {
              const from = info.startStr.slice(0, 10);
              const to = info.endStr.slice(0, 10);
              const res = await fetch(
                `/ical/data?propertyIds=${encodeURIComponent(propertyId)}&from=${from}&to=${to}`,
              );
              const json = await res.json();
              const rows = json.rows || [];

              const events = rows.map((r) => {
                const isBlock = r.isManual && r.manualType === 'block';
                const hasConflict = r.hasConflict;
                let className = 'event-booking';
                if (isBlock && hasConflict) className = 'event-block-conflict';
                else if (isBlock) className = 'event-block';

                return {
                  id: r.id,
                  title: isBlock
                    ? r.blockReason
                      ? `üîí ${r.blockReason}`
                      : 'üîí Blokada'
                    : `‚úà ${srcLabel(r['≈πr√≥d≈Ço'] || '')}`,
                  start: r._start,
                  end: r._end,
                  allDay: true,
                  classNames: [className],
                  extendedProps: { ...r, isBlock, hasConflict },
                };
              });

              // Show conflict warning if any
              const conflicts = events.filter((e) => e.extendedProps.hasConflict);
              if (conflicts.length > 0) {
                showConflictsModal(conflicts);
              }

              successCallback(events);
            } catch (e) {
              failureCallback(e);
            }
          },

          // Select date range ‚Üí create block (admin only)
          select: function (info) {
            if (!isAdmin) return;
            document.getElementById('block-start').value = info.startStr.slice(0, 10);
            document.getElementById('block-end').value = info.endStr.slice(0, 10);
            document.getElementById('block-reason').value = '';
            document.getElementById('modal-create').classList.add('active');
          },

          // Click event ‚Äî edit if admin, otherwise read-only
          eventClick: function (info) {
            const props = info.event.extendedProps;
            if (props.isBlock && isAdmin) {
              editingBlockId = info.event.id;
              document.getElementById('edit-block-start').value = new Date(props._start)
                .toISOString()
                .slice(0, 10);
              // end in DB is exclusive (= checkout day), show it directly
              document.getElementById('edit-block-end').value = new Date(props._end)
                .toISOString()
                .slice(0, 10);
              document.getElementById('edit-block-reason').value = props.blockReason || '';
              document.getElementById('edit-conflict-warning').style.display = props.hasConflict
                ? 'block'
                : 'none';
              document.getElementById('modal-edit').classList.add('active');
            } else {
              // Show read-only details
              const d = props;
              document.getElementById('view-details').innerHTML = `
                <div><b>Nieruchomo≈õƒá:</b> ${d['Nieruchomo≈õƒá'] || '‚Äî'}</div>
                <div><b>Przyjazd:</b> ${d['Data rozpoczƒôcia'] || '‚Äî'}</div>
                <div><b>Wyjazd:</b> ${d['Data zako≈Ñczenia'] || '‚Äî'}</div>
                <div><b>Platforma:</b> ${srcLabel(d['≈πr√≥d≈Ço'] || '')}</div>
                <div><b>Go≈õcie:</b> ${d['Liczba go≈õci'] !== '' ? d['Liczba go≈õci'] : '‚Äî'}</div>
                ${d['Notatki'] ? `<div><b>Notatki:</b> ${d['Notatki']}</div>` : ''}
              `;
              document.getElementById('modal-view').classList.add('active');
            }
          },
        });

        calendar.render();
      }

      // ‚îÄ‚îÄ Conflict modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function showConflictsModal(conflicts) {
        const list = document.getElementById('conflicts-list');
        list.innerHTML = conflicts
          .map((c) => {
            const p = c.extendedProps;
            const start = new Date(p._start).toLocaleDateString('pl-PL');
            const end = new Date(p._end).toLocaleDateString('pl-PL');
            return `<div style="padding:6px 0; border-bottom:1px solid #2d3748; color:#f6ad55;">
            ‚ö†Ô∏è Blokada ${start} ‚Äì ${end}
            ${p.blockReason ? `<span style="color:#94a3b8"> (${p.blockReason})</span>` : ''}
            <div style="font-size:0.78rem; color:#718096; margin-top:2px;">Nak≈Çada siƒô z rezerwacjƒÖ z platformy. Usu≈Ñ blokadƒô lub skontaktuj siƒô z platfomƒÖ.</div>
          </div>`;
          })
          .join('');
        document.getElementById('modal-conflicts').classList.add('active');
      }

      // ‚îÄ‚îÄ Create block ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function createBlock() {
        const start = document.getElementById('block-start').value;
        const end = document.getElementById('block-end').value;
        const reason = document.getElementById('block-reason').value;
        if (!start || !end) return showToast('Podaj daty blokady', 'error');

        const res = await fetch('/ical/blocks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            propertyId: selectedPropertyId,
            start: start + 'T00:00:00.000Z',
            end: end + 'T00:00:00.000Z',
            reason,
          }),
        });
        const data = await res.json();
        if (data.success) {
          closeModals();
          calendar.refetchEvents();
          showToast('Blokada dodana ‚úì');
        } else if (data.conflictType === 'ical' && data.conflicts?.length) {
          showICalConflictModal(data.conflicts, 'create');
        } else {
          showToast(data.error || 'B≈ÇƒÖd tworzenia blokady', 'error');
        }
      }

      // ‚îÄ‚îÄ Save block ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function saveBlock() {
        if (!editingBlockId) return;
        const start = document.getElementById('edit-block-start').value;
        const end = document.getElementById('edit-block-end').value;
        const reason = document.getElementById('edit-block-reason').value;
        if (!start || !end) return showToast('Podaj daty blokady', 'error');

        const res = await fetch(`/ical/blocks/${editingBlockId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            start: start + 'T00:00:00.000Z',
            end: end + 'T00:00:00.000Z',
            reason,
          }),
        });
        const data = await res.json();
        if (data.success) {
          closeModals();
          calendar.refetchEvents();
          showToast('Blokada zaktualizowana ‚úì');
        } else if (data.conflictType === 'ical' && data.conflicts?.length) {
          showICalConflictModal(data.conflicts, 'edit');
        } else {
          showToast(data.error || 'B≈ÇƒÖd aktualizacji blokady', 'error');
        }
      }

      // ‚îÄ‚îÄ Delete block ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function deleteBlock() {
        if (!editingBlockId) return;
        if (!(await showConfirm('üóë Usu≈Ñ blokadƒô', 'Na pewno usunƒÖƒá tƒô blokadƒô?'))) return;
        const res = await fetch(`/ical/blocks/${editingBlockId}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
          closeModals();
          calendar.refetchEvents();
          showToast('Blokada usuniƒôta');
        } else {
          showToast(data.error || 'B≈ÇƒÖd usuwania blokady', 'error');
        }
      }

      // ‚îÄ‚îÄ Feed URL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function updateFeedSection(property) {
        const section = document.getElementById('feed-section');
        const urlDisplay = document.getElementById('feed-url-display');
        // Only show feed controls to admins
        if (!isAdmin || !property) {
          section.style.display = 'none';
          return;
        }
        section.style.display = 'block';
        urlDisplay.textContent = property.exportUrl;
        urlDisplay.title = property.exportUrl;
      }

      function copyFeedUrl() {
        const url = document.getElementById('feed-url-display').textContent;
        navigator.clipboard.writeText(url).then(() => showToast('Link skopiowany ‚úì'));
      }

      async function regenerateToken() {
        if (!selectedPropertyId) return;
        if (
          !(await showConfirm(
            'üîÑ Regeneruj token',
            'Regeneracja tokenu sprawi, ≈ºe stary link przestanie dzia≈Çaƒá. Kontynuowaƒá?',
          ))
        )
          return;
        const res = await fetch(`/ical/properties/${selectedPropertyId}/regenerate-export-token`, {
          method: 'POST',
        });
        const data = await res.json();
        if (data.success) {
          // Update local properties list
          const p = properties.find((p) => p.id === selectedPropertyId);
          if (p) {
            p.exportToken = data.exportToken;
            p.exportUrl = data.exportUrl;
          }
          updateFeedSection(properties.find((p) => p.id === selectedPropertyId));
          showToast('Token wygenerowany ‚úì');
        } else {
          showToast(data.error || 'B≈ÇƒÖd regeneracji tokenu', 'error');
        }
      }

      // ‚îÄ‚îÄ Property selection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function selectProperty(id) {
        const prop = properties.find((p) => p.id === id);
        if (!prop) return;
        selectedPropertyId = id;
        selectedPropertyName = prop.name;
        document
          .querySelectorAll('.prop-tab')
          .forEach((b) => b.classList.toggle('active', b.dataset.id === id));
        updateFeedSection(prop);
        initCalendar(id);
      }

      // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function init() {
        await checkAuth();
        await loadProperties();
      }

      init();
    </script>
  </body>
</html>
