<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rezerwacje (iCal)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        margin: 0;
        background: #0b1020;
        color: #e4e8ff;
      }
      .container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 0 20px;
      }
      h1 {
        font-size: 24px;
        margin-bottom: 16px;
      }
      .toolbar {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 16px;
      }
      .card {
        background: #111633;
        border: 1px solid #1f2752;
        border-radius: 10px;
        padding: 16px;
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
      }
      th,
      td {
        padding: 10px 12px;
        border-bottom: 1px solid #1f2752;
        font-size: 14px;
      }
      th {
        text-align: left;
        color: #aab5ff;
        font-weight: 600;
      }
      tr:hover {
        background: #0f1430;
      }
      .badge {
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
      }
      .badge-pilne {
        background: #2a1831;
        color: #ff7ad9;
        border: 1px solid #4a2457;
      }
      .badge-normalne {
        background: #142b37;
        color: #6fe7ff;
        border: 1px solid #2a5f74;
      }
      .muted {
        color: #8ea2ff;
      }
      .footer {
        margin-top: 12px;
        color: #7b86b6;
        font-size: 13px;
      }
      select,
      button {
        background: #0d1330;
        border: 1px solid #273066;
        color: #e4e8ff;
        padding: 8px 10px;
        border-radius: 8px;
      }
      button.active {
        background: #4a2457;
        border-color: #ff7ad9;
      }
      .sync-button {
        background: #1a3d2e;
        border-color: #2d8f5c;
        color: #7fffb3;
      }
      .sync-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      a {
        color: #88c6ff;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      .input {
        width: 100%;
        background: #0d1330;
        border: 1px solid #273066;
        color: #e4e8ff;
        padding: 6px 8px;
        border-radius: 8px;
      }
      .list {
        margin: 8px 0;
        padding-left: 18px;
        color: #aab5ff;
      }
      .chip {
        display: inline-block;
        background: #0d1330;
        border: 1px solid #273066;
        border-radius: 999px;
        padding: 4px 8px;
        margin: 2px 4px;
        font-size: 12px;
      }
      .mb-4 {
        margin-bottom: 1rem;
      }
      .px-4 {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      .py-2 {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
      }
      .ml-2 {
        margin-left: 0.5rem;
      }
      .rounded {
        border-radius: 0.375rem;
      }
      .bg-blue-600 {
        background-color: #2563eb;
      }
      .bg-gray-700 {
        background-color: #374151;
      }
      .bg-gray-600 {
        background-color: #4b5563;
      }
      .text-white {
        color: #ffffff;
      }
      .text-gray-300 {
        color: #d1d5db;
      }
      .text-sm {
        font-size: 0.875rem;
      }
      .opacity-75 {
        opacity: 0.75;
      }
      .hover\:bg-gray-600:hover {
        background-color: #4b5563;
      }
      .new-booking {
        background: linear-gradient(90deg, #1a3a1a 0%, #111633 100%);
        border-left: 4px solid #22c55e;
        animation: pulse-new 2s infinite;
      }
      @keyframes pulse-new {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
        }
        50% {
          box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
        }
      }
      .new-badge {
        background: #22c55e;
        color: white;
        padding: 2px 6px;
        border-radius: 999px;
        font-size: 10px;
        font-weight: 600;
        margin-left: 8px;
        animation: blink 1s infinite;
      }
      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0.6;
        }
      }
      .apartment-multiselect {
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        font-size: 14px;
        background: #0d1330;
        color: #e4e8ff;
        border: 1px solid #273066;
        border-radius: 8px;
        min-width: 220px;
        min-height: 60px;
        max-width: 320px;
        max-height: 120px;
        padding: 8px;
        box-sizing: border-box;
        outline: none;
        vertical-align: middle;
      }
      .apartment-select-trigger {
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        font-size: 14px;
        background: #0d1330;
        color: #e4e8ff;
        border: 1px solid #273066;
        border-radius: 8px;
        min-width: 220px;
        padding: 8px 12px;
        cursor: pointer;
        user-select: none;
      }
      .apartment-select-trigger:focus {
        outline: 2px solid #4a2457;
      }
      .opis-cell {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      @media (max-width: 768px) {
        /* Ukryj kolumny Opis i Źródło na małych ekranach */
        th:nth-child(4),
        td:nth-child(4),
        th:nth-child(5),
        td:nth-child(5) {
          display: none;
        }
      }

      /* New Toolbar Styles */
      .main-toolbar {
        display: flex;
        gap: 24px;
        align-items: center;
        margin-bottom: 16px;
        padding: 16px;
        background: #111633;
        border: 1px solid #1f2752;
        border-radius: 12px;
        flex-wrap: wrap;
      }

      .toolbar-section {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .filter-group {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .filter-label {
        font-size: 14px;
        color: #aab5ff;
        white-space: nowrap;
      }

      .filter-input,
      .filter-select {
        background: #0d1330;
        border: 1px solid #273066;
        color: #e4e8ff;
        padding: 6px 8px;
        border-radius: 6px;
        font-size: 14px;
        min-width: 80px;
      }

      .filter-input:focus,
      .filter-select:focus {
        outline: none;
        border-color: #4a2457;
        box-shadow: 0 0 0 2px rgba(74, 36, 87, 0.2);
      }

      .button-group {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .action-button {
        background: #1f2752;
        border: 1px solid #273066;
        color: #e4e8ff;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
        white-space: nowrap;
      }

      .action-button:hover {
        background: #273066;
        border-color: #4a2457;
      }

      .action-button.primary {
        background: #4a2457;
        border-color: #6b2d9b;
        font-weight: 600;
      }

      .action-button.active {
        background: #22c55e;
        border-color: #16a34a;
        color: white;
      }

      .action-button.sync {
        background: #2563eb;
        border-color: #1d4ed8;
        font-weight: 600;
      }

      .action-button.sync:hover {
        background: #1d4ed8;
      }

      .action-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .config-button {
        background: #374151;
        border: 1px solid #4b5563;
        color: #d1d5db;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        text-decoration: none;
        display: inline-block;
        transition: all 0.2s ease;
        position: absolute;
        top: 20px;
        right: 20px;
      }

      .config-button:hover {
        background: #4b5563;
        color: #ffffff;
      }

      /* Responsive adjustments */
      @media (max-width: 1024px) {
        .main-toolbar {
          flex-direction: column;
          align-items: stretch;
          gap: 16px;
        }

        .toolbar-section {
          justify-content: center;
        }
      }

      @media (max-width: 768px) {
        .filter-group {
          flex-direction: column;
          align-items: flex-start;
          gap: 4px;
        }

        .filter-label {
          margin-bottom: 2px;
        }

        .button-group {
          flex-wrap: wrap;
          justify-content: center;
        }

        .action-button {
          flex: 1;
          min-width: 120px;
        }
      }

      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(11, 16, 32, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }
      .modal-overlay.active {
        opacity: 1;
        visibility: visible;
      }
      .modal-content {
        background: #111633;
        border: 1px solid #1f2752;
        border-radius: 12px;
        padding: 24px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        transform: scale(0.9) translateY(-20px);
        transition: all 0.3s ease;
      }
      .modal-overlay.active .modal-content {
        transform: scale(1) translateY(0);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #1f2752;
      }
      .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #e4e8ff;
        margin: 0;
      }
      .modal-close {
        background: none;
        border: none;
        color: #8ea2ff;
        font-size: 20px;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: background 0.2s ease;
      }
      .modal-close:hover {
        background: #1f2752;
        color: #e4e8ff;
      }
      .modal-body {
        color: #aab5ff;
        line-height: 1.5;
      }
      .modal-stats {
        background: #0d1330;
        border: 1px solid #273066;
        border-radius: 8px;
        padding: 16px;
        margin: 12px 0;
      }
      .modal-stat {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      .modal-stat:last-child {
        margin-bottom: 0;
      }
      .modal-stat-label {
        color: #8ea2ff;
      }
      .modal-stat-value {
        color: #e4e8ff;
        font-weight: 600;
      }
      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 20px;
      }
      .modal-btn {
        padding: 8px 16px;
        border-radius: 8px;
        border: 1px solid #273066;
        background: #0d1330;
        color: #e4e8ff;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .modal-btn:hover {
        background: #273066;
      }
      .modal-btn-primary {
        background: #1a3d2e;
        border-color: #2d8f5c;
        color: #7fffb3;
      }
      .modal-btn-primary:hover {
        background: #2d8f5c;
      }
    </style>
  </head>
  <body>
    <div id="app"></div>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script>
      const { createApp, ref, computed, onMounted, watch } = Vue;
      createApp({
        setup() {
          const loading = ref(true);
          const error = ref('');
          const rows = ref([]);
          const daysAhead = ref(35);
          const sortBy = ref('end');
          const from = ref('');
          const to = ref('');
          const newName = ref('');
          const newUrl = ref('');
          const newSource = ref('');
          const appendConfig = ref(true);
          const properties = ref([]);
          const saving = ref(false);
          let saveTimer = null;

          const propertiesWithCosts = ref([]);

          // Helper function to map raw booking data to standardized format
          const mapBookingData = (rawRows) => {
            return (rawRows || []).map((it) => {
              // Backend already returns data in the correct format, just pass it through
              return {
                ...it,
                // Ensure all required fields exist with fallbacks
                Nieruchomość: it['Nieruchomość'] || it.propertyName || 'Nieznana',
                'Data rozpoczęcia':
                  it['Data rozpoczęcia'] ||
                  (it.start ? new Date(it.start).toLocaleDateString('pl-PL') : ''),
                'Data zakończenia':
                  it['Data zakończenia'] ||
                  (it.end ? new Date(it.end).toLocaleDateString('pl-PL') : ''),
                'Status wyjazdu':
                  it['Status wyjazdu'] ||
                  (typeof it.isUrgentChangeover === 'boolean'
                    ? it.isUrgentChangeover
                      ? 'PILNE'
                      : 'NORMALNE'
                    : 'NORMALNE'),
                Opis: it['Opis'] || it.description || '',
                Źródło: it['Źródło'] || it.source || '',
                'Liczba gości':
                  it['Liczba gości'] !== undefined
                    ? it['Liczba gości']
                    : typeof it.guests === 'number'
                    ? it.guests
                    : '',
                Notatki: it['Notatki'] || it.notes || '',
                id: it.id || it._id || '',
                groupId: it.groupId || null,
                isNew: it.isNew || false,
                createdAt: it.createdAt,
                updatedAt: it.updatedAt,
              };
            });
          };

          const selectedApartments = ref([]);

          const showApartmentDropdown = ref(false);

          const selectedGroup = ref('');

          const groups = ref([]);

          const showCancelled = ref(false);

          const modal = ref({
            show: false,
            title: '',
            message: '',
            stats: null,
          });

          const apartmentNames = computed(() => {
            // Unique apartment names from all rows
            const names = rows.value.map((r) => r['Nieruchomość']);
            return [...new Set(names)].sort();
          });

          const filteredRows = computed(() => {
            let filtered = rows.value;
            if (selectedGroup.value) {
              filtered = filtered.filter((row) => row.groupId === selectedGroup.value);
            }
            if (selectedApartments.value.length > 0) {
              filtered = filtered.filter((r) =>
                selectedApartments.value.includes(r['Nieruchomość']),
              );
            }
            return filtered;
          });

          const currentSummary = computed(() => {
            const propMap = new Map(
              propertiesWithCosts.value.map((p) => [p.name, p.cleaningCost || 0]),
            );
            let total = 0;
            filteredRows.value.forEach((row) => {
              total += propMap.get(row['Nieruchomość']) || 0;
            });
            const bookingCount = filteredRows.value.length;
            const uniqueProperties = new Set(filteredRows.value.map((row) => row['Nieruchomość']));

            let summary = `${bookingCount} rezerwacji`;
            if (uniqueProperties.size > 0) {
              summary += `, ${uniqueProperties.size} nieruchomości`;
            }
            if (total > 0) {
              summary += `, ${total} PLN`;
            }

            return summary;
          });

          const groupsWithCounts = computed(() => {
            return groups.value.map((group) => {
              const groupRows = rows.value.filter((row) => row.groupId === group._id);
              return {
                ...group,
                propertyCount: group.propertyCount || 0, // Use count from backend
                bookingCount: groupRows.length,
              };
            });
          });

          const selectedGroupData = computed(() => {
            if (!selectedGroup.value) return null;
            return groupsWithCounts.value.find((g) => g._id === selectedGroup.value);
          });

          const newBookingsCount = computed(() => {
            return filteredRows.value.filter((row) => row.isNew).length;
          });

          const fetchData = async () => {
            loading.value = true;
            error.value = '';
            try {
              const params = new URLSearchParams({
                daysAhead: String(daysAhead.value),
                sortBy: String(sortBy.value),
              });
              if (from.value) params.set('from', from.value);
              if (to.value) params.set('to', to.value);
              if (showCancelled.value) params.set('includeCancelled', 'true');
              const res = await fetch(`/ical/data?${params.toString()}`);
              const data = await res.json();
              if (!data.success) throw new Error(data.error || 'Błąd');
              rows.value = mapBookingData(data.rows);
            } catch (e) {
              error.value = e.message || 'Błąd';
            } finally {
              loading.value = false;
            }
          };

          const updateGuests = async (row) => {
            if (!row.id) return;
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
              try {
                saving.value = true;
                await fetch('/ical/guests', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    id: row.id,
                    guests: Number(row['Liczba gości'] || 0),
                  }),
                });
              } catch (e) {
                console.error(e);
              } finally {
                saving.value = false;
              }
            }, 500);
          };

          const updateNotes = async (row) => {
            if (!row.id) return;
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
              try {
                saving.value = true;
                await fetch('/ical/notes', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    id: row.id,
                    notes: row['Notatki'] || '',
                  }),
                });
              } catch (e) {
                console.error(e);
              } finally {
                saving.value = false;
              }
            }, 500);
          };

          // Helper that formats a Date to local YYYY-MM-DD
          const formatLocalDate = (d) => {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
          };

          // Returns start/end Date objects for month offset from current (0 = current month, -1 = previous)
          const getMonthRange = (offsetMonths = 0) => {
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth() + offsetMonths, 1);
            const end = new Date(now.getFullYear(), now.getMonth() + offsetMonths + 1, 0);
            return { start, end };
          };

          const setMonthByOffset = (offsetMonths) => {
            const { start, end } = getMonthRange(offsetMonths);
            from.value = formatLocalDate(start);
            to.value = formatLocalDate(end);
            // Reset filters when changing date range to show all data
            selectedGroup.value = '';
            selectedApartments.value = [];
            fetchData();
          };

          const setCurrentMonth = () => setMonthByOffset(0);

          const setPreviousMonth = () => setMonthByOffset(-1);

          const setNextMonth = () => setMonthByOffset(1);

          const fetchProperties = async () => {
            try {
              const res = await fetch('/ical/properties');
              const data = await res.json();
              // Group properties by name and take the cleaning cost from any source (they should be the same for logical property)
              const propMap = new Map();
              data.properties.forEach((p) => {
                if (!propMap.has(p.name)) {
                  propMap.set(p.name, { cleaningCost: p.cleaningCost || 0, sources: [] });
                }
                propMap.get(p.name).sources.push(p.source);
              });
              propertiesWithCosts.value = Array.from(propMap.entries()).map(([name, data]) => ({
                name,
                cleaningCost: data.cleaningCost,
                sources: data.sources,
              }));
            } catch (e) {
              console.error('Failed to fetch properties:', e);
            }
          };

          // Watch for showCancelled changes and refresh data
          watch(showCancelled, async () => {
            await fetchData();
          });

          // Watch for apartment selection changes and refresh data
          watch(
            selectedApartments,
            async (newSelection) => {
              // No need to refresh data - filtering is done on frontend
            },
            { deep: true },
          );

          // Watch for filter changes and refresh data
          watch(daysAhead, async () => {
            await fetchData();
          });

          watch(from, async () => {
            await fetchData();
          });

          watch(to, async () => {
            await fetchData();
          });

          watch(sortBy, async () => {
            await fetchData();
          });

          const fetchGroups = async () => {
            try {
              const res = await fetch('/ical/groups');
              const data = await res.json();
              groups.value = data.groups;
            } catch (e) {
              console.error('Failed to fetch groups:', e);
            }
          };

          const currentPage = ref(1);
          const hasMore = ref(false);
          const totalCount = ref(0);

          const fetchAllData = async (page = 1) => {
            loading.value = true;
            error.value = '';
            try {
              const params = new URLSearchParams({
                sortBy: String(sortBy.value),
                all: 'true',
                page: String(page),
                limit: '30',
              });
              const res = await fetch(`/ical/data?${params.toString()}`);
              const data = await res.json();
              if (!data.success) throw new Error(data.error || 'Błąd');
              if (page === 1) {
                rows.value = mapBookingData(data.rows);
              } else {
                rows.value.push(...mapBookingData(data.rows));
              }
              currentPage.value = page;
              hasMore.value = data.hasMore;
              totalCount.value = data.totalCount;
            } catch (e) {
              error.value = e.message || 'Błąd';
            } finally {
              loading.value = false;
            }
          };

          const loadMore = () => {
            fetchAllData(currentPage.value + 1);
          };

          const syncing = ref(false);

          const syncNow = async () => {
            syncing.value = true;
            try {
              const syncData = {
                daysAhead: daysAhead.value,
              };
              if (selectedGroup.value) {
                syncData.groupId = selectedGroup.value;
              }
              if (selectedApartments.value.length > 0) {
                syncData.propertyNames = selectedApartments.value.join(',');
              }

              const res = await fetch('/ical/sync', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(syncData),
              });
              const data = await res.json();
              if (!data.success) throw new Error(data.error || 'Sync failed');

              // Refresh data after sync
              await fetchData();

              // Show success modal
              showModal('Synchronizacja zakończona!', data.message, data.stats);
            } catch (e) {
              showModal('Błąd synchronizacji', e.message, null);
            } finally {
              syncing.value = false;
            }
          };

          const showModal = (title, message, stats = null) => {
            // Translate stats keys to Polish
            const translatedStats = stats
              ? {
                  'Zsynchronizowane nieruchomości': stats.propertiesSynced,
                  'Zaktualizowane rezerwacje': stats.bookingsUpdated,
                  'Anulowane rezerwacje': stats.bookingsCancelled,
                }
              : null;

            modal.value = {
              show: true,
              title,
              message,
              stats: translatedStats,
            };
          };

          const closeModal = () => {
            modal.value.show = false;
          };

          // Load initial data when component mounts
          onMounted(async () => {
            await fetchAllData();
            await fetchProperties();
            await fetchGroups();
          });

          return {
            loading,
            error,
            rows,
            daysAhead,
            sortBy,
            fetchData,
            fetchAllData,
            loadMore,
            currentPage,
            hasMore,
            totalCount,
            newName,
            newUrl,
            newSource,
            properties,
            appendConfig,
            updateGuests,
            updateNotes,
            saving,
            from,
            to,
            setCurrentMonth,
            setPreviousMonth,
            setNextMonth,
            selectedApartments,
            apartmentNames,
            filteredRows,
            showApartmentDropdown,
            currentSummary,
            selectedGroup,
            groups,
            groupsWithCounts,
            selectedGroupData,
            newBookingsCount,
            syncing,
            syncNow,
            showCancelled,
            modal,
            showModal,
            closeModal,
          };
        },
        template: `
          <div class="container">
            <a href="/config" class="config-button">Konfiguracja iCal</a>
            <h1>Rezerwacje (następne 35 dni)</h1>
            
            <!-- Group Selection Toolbar -->
            <div class="toolbar mb-4">
              <button 
                @click="selectedGroup = ''" 
                :class="['px-4 py-2 rounded', selectedGroup === '' ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600']"
              >
                Wszystkie
              </button>
              <button 
                v-for="group in groupsWithCounts" 
                :key="group._id" 
                @click="selectedGroup = group._id" 
                :class="['px-4 py-2 rounded ml-2', selectedGroup === group._id ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600']"
              >
                {{ group.name }} 
                <span class="text-sm opacity-75">({{ group.propertyCount }} obj., {{ group.bookingCount }} rez.)</span>
              </button>
            </div>

            <p>Podsumowanie: {{ currentSummary }}
              <span v-if="newBookingsCount > 0" class="new-badge">{{ newBookingsCount }} z dzisiaj</span>
            </p>

            <!-- Main Controls Toolbar -->
            <div class="main-toolbar">
              <!-- Left Section: Filters -->
              <div class="toolbar-section">
                <div class="filter-group">
                  <label class="filter-label">Zakres dni:</label>
                  <input type="number" min="1" max="365" v-model.number="daysAhead" class="filter-input"/>
                </div>

                <div class="filter-group">
                  <label class="filter-label">Sortuj po:</label>
                  <select v-model="sortBy" class="filter-select">
                    <option value="start">przyjeździe</option>
                    <option value="end">wyjeździe</option>
                  </select>
                </div>

                <div class="filter-group">
                  <label class="filter-label">Od:</label>
                  <input type="date" v-model="from" class="filter-input"/>
                </div>

                <div class="filter-group">
                  <label class="filter-label">Do:</label>
                  <input type="date" v-model="to" class="filter-input"/>
                </div>
              </div>

              <!-- Center Section: Quick Actions -->
              <div class="toolbar-section">
                <div class="button-group">
                  <button @click="setPreviousMonth" class="action-button">◀ Poprzedni</button>
                  <button @click="setCurrentMonth" class="action-button primary">Aktualny</button>
                  <button @click="setNextMonth" class="action-button">Następny ▶</button>
                </div>
              </div>

              <!-- Right Section: Main Actions -->
              <div class="toolbar-section">
                <div class="button-group">
                  <button @click="showCancelled = !showCancelled" :class="['action-button', showCancelled ? 'active' : '']">
                    {{ showCancelled ? 'Ukryj anulowane' : 'Pokaż anulowane' }}
                  </button>
                  <button @click="syncNow" :disabled="syncing" class="action-button sync">
                    {{ syncing ? 'Synchronizuję...' : 'Synchronizuj iCal' }}
                  </button>
                </div>
              </div>
            </div>
<div style="margin-bottom:12px; position:relative; z-index:20;">
  <div
    class="apartment-select-trigger"
    @click="showApartmentDropdown = !showApartmentDropdown"
    tabindex="0"
    @blur="showApartmentDropdown = false"
    style="display:inline-block; min-width:220px;"
  >
    <span v-if="!selectedApartments.length" style="color:#888;">Filtruj nieruchomości</span>
    <span v-else>
      {{ selectedApartments.join(', ') }}
    </span>
    <span style="float:right; opacity:0.7;">▼</span>
  </div>
  <div
    v-if="showApartmentDropdown"
    class="apartment-dropdown"
    @mousedown.prevent
    style="position:absolute; left:0; top:110%; background:#0d1330; border:1px solid #273066; border-radius:8px; min-width:220px; max-height:150px; overflow:auto; box-shadow:0 2px 8px #0003; padding:4px 0;"
  >
    <label v-for="name in apartmentNames" :key="name" style="display:block; padding:6px 12px; cursor:pointer; font-size:14px;">
      <input
        type="checkbox"
        :value="name"
        v-model="selectedApartments"
        style="margin-right:8px;"
      />
      {{ name }}
    </label>
  </div>
</div>
            <div class="card">
              <div v-if="loading">Ładowanie...</div>
              <div v-else-if="error">Błąd: {{ error }}</div>
              <div v-else>
                <div style="overflow-x:auto;">
                  <table>
                    <thead>
                      <tr>
                        <th>Nieruchomość</th>
                        <th>Check-in</th>
                        <th>Check-out</th>
                        <th>Status wyjazdu</th>
                        <th>Liczba gości</th>
                        <th>Notatki</th>
                        <th class="muted">Opis</th>
                        <th class="muted">Źródło</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="(r, idx) in filteredRows" :key="idx" :class="{ 'new-booking': r.isNew }">
                        <td>
                          {{ r['Nieruchomość'] }}
                          <span v-if="r.isNew" class="new-badge">DZISIAJ</span>
                        </td>
                        <td>{{ r['Data rozpoczęcia'] }}</td>
                        <td>{{ r['Data zakończenia'] }}</td>
                        <td>
                          <span :class="['badge', r['Status wyjazdu'] === 'PILNE' ? 'badge-pilne' : 'badge-normalne']">
                            {{ r['Status wyjazdu'] }}
                          </span>
                        </td>
                        <td>
                          <input class="input" type="number" min="0" max="20" v-model.number="r['Liczba gości']" @input="updateGuests(r)" style="width:80px;" />
                        </td>
                        <td>
                          <input class="input" type="text" v-model="r['Notatki']" @input="updateNotes(r)" style="width:120px;" />
                        </td>
                        <td class="muted opis-cell">{{ r['Opis'] }}</td>
                        <td class="muted"><a :href="r['Źródło']" target="_blank">źródło</a></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div class="footer">Wskazówka: Status wyjazdu = "PILNE" oznacza przyjazd tego samego dnia. <span v-if="saving" style="margin-left:8px;">Zapisuję...</span></div>
                <div v-if="hasMore" style="text-align:center; margin-top:12px;">
                  <button @click="loadMore" style="background:#273066; border:1px solid #4a2457; color:#e4e8ff; padding:8px 16px; border-radius:8px; cursor:pointer;">
                    {{"Załaduj więcej"}} ({{ currentPage * 30 }} z {{ totalCount }})
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal -->
          <div class="modal-overlay" :class="{ active: modal.show }" @click="closeModal">
            <div class="modal-content" @click.stop>
              <div class="modal-header">
                <h3 class="modal-title">{{ modal.title }}</h3>
                <button class="modal-close" @click="closeModal">&times;</button>
              </div>
              <div class="modal-body">
                <p>{{ modal.message }}</p>
                <div v-if="modal.stats" class="modal-stats">
                  <div v-for="(value, key) in modal.stats" :key="key" class="modal-stat">
                    <span class="modal-stat-label">{{ key }}:</span>
                    <span class="modal-stat-value">{{ value }}</span>
                  </div>
                </div>
              </div>
              <div class="modal-actions">
                <button class="modal-btn modal-btn-primary" @click="closeModal">OK</button>
              </div>
            </div>
          </div>
        `,
      }).mount('#app');
    </script>
  </body>
</html>
